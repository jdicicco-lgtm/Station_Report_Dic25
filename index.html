<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Fleet & Booking Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>

<body class="bg-slate-950 text-slate-100">

<div class="max-w-7xl mx-auto p-6 space-y-8">

  <!-- FILTRI -->
  <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
    <input type="date" id="dateFrom" class="bg-slate-800 p-2 rounded">
    <input type="date" id="dateTo" class="bg-slate-800 p-2 rounded">

    <select id="stationFilter" class="bg-slate-800 p-2 rounded"></select>
    <select id="providerFilter" class="bg-slate-800 p-2 rounded"></select>
    <select id="channelFilter" class="bg-slate-800 p-2 rounded"></select>
  </div>

  <!-- KPI -->
  <div id="kpiContainer" class="grid grid-cols-1 md:grid-cols-4 gap-6"></div>

  <!-- GRAFICI -->
 <div class="grid grid-cols-1 xl:grid-cols-2 gap-8">
  <div class="h-[380px]">
    <canvas id="lineDaily"></canvas>
  </div>
  <div class="h-[380px]">
    <canvas id="lineStation"></canvas>
  </div>
</div>

  <div class="grid grid-cols-1 xl:grid-cols-2 gap-8">
  <div class="h-[320px]">
    <canvas id="donutFleet"></canvas>
  </div>
  <div class="h-[320px]">
    <canvas id="donutMaintenance"></canvas>
  </div>
</div>

<script>
/* ===============================
   LOAD DATA
================================ */
let bookings = [], stations = [], maintenance = [];

Promise.all([
  fetch('prenotazioni.json').then(r => r.json()),
  fetch('reporting_stations.json').then(r => r.json()),
  fetch('maintenance_services.json').then(r => r.json())
]).then(([b, s, m]) => {
  bookings = b;
  stations = s;
  maintenance = m;
  init();
});

/* ===============================
   INIT
================================ */
function init() {
  populateFilters();
  setDefaultDates();
  applyFilters();
  document.querySelectorAll('input,select')
    .forEach(el => el.addEventListener('change', applyFilters));
}

/* ===============================
   HELPERS
================================ */
const sum = (arr, fn) => arr.reduce((a,b)=>a+fn(b),0);
const avg = (arr, fn) => arr.length ? sum(arr,fn)/arr.length : 0;
const pct = (c,p) => p === 0 ? 0 : ((c-p)/p)*100;

/* ===============================
   FILTER SETUP
================================ */
function populateFilters() {

  stationFilter.innerHTML =
    `<option value="">All Stations</option>` +
    [...new Set(stations.map(s => s.Station))]
      .map(v => `<option>${v}</option>`).join('');

  providerFilter.innerHTML =
    `<option value="">All Providers</option>` +
    [...new Set(bookings.map(b => b.Provider).filter(Boolean))]
      .map(v => `<option>${v}</option>`).join('');

  channelFilter.innerHTML =
    `<option value="">All Channels</option>` +
    [...new Set(bookings.map(b => b["Selling channel"]).filter(Boolean))]
      .map(v => `<option>${v}</option>`).join('');
}

function setDefaultDates() {
  const dates = bookings.map(b => new Date(b.Checkout));
  const min = new Date(Math.min(...dates));
  const max = new Date(Math.max(...dates));
  dateFrom.value = min.toISOString().slice(0,10);
  dateTo.value = max.toISOString().slice(0,10);
}

/* ===============================
   CORE LOGIC
================================ */
function applyFilters() {

  const from = new Date(dateFrom.value);
  const to = new Date(dateTo.value);
  const days = Math.max(1, (to - from) / 86400000);

  const prevFrom = new Date(from.getTime() - days*86400000);
  const prevTo = from;

  const st = stationFilter.value;
  const pr = providerFilter.value;
  const ch = channelFilter.value;

  const filterBooking = (b, f, t) =>
    (!st || b["Checkout Station"] === st) &&
    (!pr || b.Provider === pr) &&
    (!ch || b["Selling channel"] === ch) &&
    new Date(b.Checkout) >= f &&
    new Date(b.Checkout) <= t;

  const curr = bookings.filter(b => filterBooking(b, from, to));
  const prev = bookings.filter(b => filterBooking(b, prevFrom, prevTo));

  renderKPIs(curr, prev, st);
  renderCharts(curr, st);
}

/* ===============================
   KPI
================================ */
function renderKPIs(curr, prev, station) {

  const kpis = [
    {
      label: "Prenotazioni",
      v: curr.length,
      p: prev.length
    },
    {
      label: "Revenue €",
      v: sum(curr, b => b["Total revenue"] || 0),
      p: sum(prev, b => b["Total revenue"] || 0)
    },
    {
      label: "Ancillaries €",
      v: sum(curr, b => b.Ancillaries || 0),
      p: sum(prev, b => b.Ancillaries || 0)
    },
    {
      label: "RevDay Anc.",
      v: avg(curr, b => b["RevDay Ancillaries"] || 0),
      p: avg(prev, b => b["RevDay Ancillaries"] || 0)
    }
  ];

  const fleet = stations.filter(s => !station || s.Station === station);

  kpis.push(
    {
      label: "% Utilization",
      v: avg(fleet, s => s.utilization_current)*100,
      p: 0
    },
    {
      label: "Fleet Current",
      v: avg(fleet, s => s.fleet_current),
      p: 0
    },
    {
      label: "Vehicles in Maintenance",
      v: maintenance.filter(m => !station || m["Branch Office"] === station).length,
      p: 0
    }
  );

  kpiContainer.innerHTML = kpis.map(k => {
    const d = pct(k.v, k.p);
    return `
      <div class="bg-slate-900 p-4 rounded">
        <div class="text-slate-400 text-sm">${k.label}</div>
        <div class="text-2xl font-bold">${k.v.toFixed(1)}</div>
        <div class="${d>=0?'text-green-400':'text-red-400'} text-sm">
          ${d.toFixed(1)}%
        </div>
      </div>`;
  }).join('');
}

/* ===============================
   CHARTS
================================ */
let charts = {};

function renderCharts(currBookings, selectedStation) {

  /* ===============================
     CLEANUP
  ================================ */
  Object.values(charts).forEach(c => c.destroy());
  charts = {};

  /* ===============================
     LINE CHART – ANDAMENTO GIORNALIERO
  ================================ */
  const dailyMap = {};

  currBookings.forEach(b => {
    const day = new Date(b.Checkout).toISOString().slice(0, 10);
    dailyMap[day] ??= { count: 0, revenue: 0, anc: 0, revDay: 0 };
    dailyMap[day].count++;
    dailyMap[day].revenue += b["Total revenue"] || 0;
    dailyMap[day].anc += b.Ancillaries || 0;
    dailyMap[day].revDay += b["RevDay Ancillaries"] || 0;
  });

  const days = Object.keys(dailyMap).sort();

  charts.lineDaily = new Chart(lineDaily, {
    type: "line",
    data: {
      labels: days,
      datasets: [{
        label: "Prenotazioni",
        data: days.map(d => dailyMap[d].count),
        borderColor: "#38bdf8",
        backgroundColor: "rgba(56,189,248,0.15)",
        fill: true,
        tension: 0.35,
        pointRadius: 3
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        title: {
          display: true,
          text: "Andamento Prenotazioni Giornaliere",
          color: "#e5e7eb",
          font: { size: 16, weight: "600" },
          padding: { bottom: 12 }
        },
        legend: { display: false },
        tooltip: {
          callbacks: {
            afterLabel: ctx => {
              const d = dailyMap[ctx.label];
              return [
                `Revenue: €${d.revenue.toFixed(2)}`,
                `Ancillaries: €${d.anc.toFixed(2)}`,
                `RevDay Anc: €${(d.revDay / d.count || 0).toFixed(2)}`
              ];
            }
          }
        }
      }
    }
  });

  /* ===============================
     LINE CHART – PERFORMANCE STATION
  ================================ */
  const stationData = stations.filter(
    s => !selectedStation || s.Station === selectedStation
  );

  if (stationData.length) {
    charts.lineStation = new Chart(lineStation, {
      type: "line",
      data: {
        labels: stationData.map(s => s.Station),
        datasets: [
          {
            label: "Fleet Current",
            data: stationData.map(s => s.fleet_current),
            borderColor: "#22c55e",
            tension: 0.3
          },
          {
            label: "Utilization %",
            data: stationData.map(s => s.utilization_current * 100),
            borderColor: "#f59e0b",
            tension: 0.3,
            yAxisID: "y1"
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          title: {
            display: true,
            text: "Performance Flotta per Station",
            color: "#e5e7eb",
            font: { size: 16, weight: "600" },
            padding: { bottom: 12 }
          },
          legend: { position: "top" }
        },
        scales: {
          y: { position: "left" },
          y1: {
            position: "right",
            grid: { drawOnChartArea: false },
            ticks: { callback: v => v + "%" }
          }
        }
      }
    });
  }

  /* ===============================
     DONUT – FLEET PER STATION
  ================================ */
  if (stationData.length) {
    charts.donutFleet = new Chart(donutFleet, {
      type: "doughnut",
      data: {
        labels: stationData.map(s => s.Station),
        datasets: [{
          data: stationData.map(s => s.fleet_current)
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          title: {
            display: true,
            text: "Distribuzione Fleet Current per Station",
            color: "#e5e7eb",
            font: { size: 16, weight: "600" },
            padding: { bottom: 12 }
          },
          legend: { position: "right" }
        }
      }
    });
  }

  /* ===============================
     DONUT – MANUTENZIONE PER TIPO
     (NON filtrata per station)
  ================================ */
  const maintMap = {};

  maintenance.forEach(m => {
    maintMap[m.Type] = (maintMap[m.Type] || 0) + 1;
  });

  if (Object.keys(maintMap).length) {
    charts.donutMaintenance = new Chart(donutMaintenance, {
      type: "doughnut",
      data: {
        labels: Object.keys(maintMap),
        datasets: [{
          data: Object.values(maintMap)
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          title: {
            display: true,
            text: "Distribuzione Interventi di Manutenzione",
            color: "#e5e7eb",
            font: { size: 16, weight: "600" },
            padding: { bottom: 12 }
          },
          legend: { position: "right" }
        }
      }
    });
  }
}

</script>
</body>
</html>
