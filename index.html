<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Fleet & Booking Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <!-- Tailwind config -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            christmas: {
              green: '#0f766e',
              gold: '#facc15',
              dark: '#020617'
            }
          }
        }
      }
    }
  </script>
</head>

<body class="bg-gradient-to-br from-slate-950 via-slate-900 to-slate-950 text-slate-100">

<div class="max-w-7xl mx-auto p-6 space-y-10">

  <!-- HEADER -->
  <div class="flex items-center justify-between">
    <h1 class="text-2xl font-semibold tracking-wide">
      ðŸŽ„ Fleet & Booking Dashboard
      <span class="text-sm text-slate-400 ml-2">Christmas Edition</span>
    </h1>
    <div class="text-sm text-slate-400">
      Data-driven view Â· Winter 2025
    </div>
  </div>

  <!-- FILTRI -->
  <div class="grid grid-cols-1 md:grid-cols-7 gap-4 bg-slate-900/70 p-4 rounded-xl border border-slate-800">
    <input type="date" id="dateFrom" class="bg-slate-800 p-2 rounded">
    <input type="date" id="dateTo" class="bg-slate-800 p-2 rounded">

    <select id="stationFilter" class="bg-slate-800 p-2 rounded"></select>
    <select id="providerFilter" class="bg-slate-800 p-2 rounded"></select>
    <select id="agentFilter" class="bg-slate-800 p-2 rounded"></select>
    <select id="channelFilter" class="bg-slate-800 p-2 rounded"></select>

    <button id="cleanFilters"
      class="bg-christmas-green hover:bg-emerald-700 transition p-2 rounded text-sm font-medium">
      Clean Filters
    </button>
  </div>

  <!-- KPI -->
  <div id="kpiContainer" class="grid grid-cols-1 md:grid-cols-3 xl:grid-cols-6 gap-6"></div>

  <!-- GRAFICI -->
  <div class="grid grid-cols-1 xl:grid-cols-2 gap-8">
    <div class="h-[380px] bg-slate-900/70 p-4 rounded-xl border border-slate-800 shadow">
      <canvas id="lineDaily"></canvas>
    </div>
    <div class="h-[380px] bg-slate-900/70 p-4 rounded-xl border border-slate-800 shadow">
      <canvas id="lineStation"></canvas>
    </div>
  </div>

  <div class="grid grid-cols-1 xl:grid-cols-2 gap-8">
    <div class="h-[320px] bg-slate-900/70 p-4 rounded-xl border border-slate-800 shadow">
      <canvas id="donutFleet"></canvas>
    </div>
    <div class="h-[320px] bg-slate-900/70 p-4 rounded-xl border border-slate-800 shadow">
      <canvas id="donutMaintenance"></canvas>
    </div>
  </div>

</div>

<script>
/* ===============================
   LOAD DATA
================================ */
let bookings = [], stations = [], maintenance = [];

Promise.all([
  fetch('prenotazioni.json').then(r => r.json()),
  fetch('reporting_stations.json').then(r => r.json()),
  fetch('maintenance_services.json').then(r => r.json())
]).then(([b, s, m]) => {
  bookings = b;
  stations = s;
  maintenance = m;
  init();
});

/* ===============================
   INIT
================================ */
function init() {
  populateFilters();
  setDefaultDates();
  applyFilters();

  dateFrom.addEventListener('change', applyFilters);
  dateTo.addEventListener('change', applyFilters);
  stationFilter.addEventListener('change', applyFilters);
  providerFilter.addEventListener('change', applyFilters);
  agentFilter.addEventListener('change', applyFilters);
  channelFilter.addEventListener('change', applyFilters);
  cleanFilters.addEventListener('click', resetFilters);
}

/* ===============================
   HELPERS
================================ */
const sum = (a,f)=>a.reduce((x,y)=>x+f(y),0);
const avg = (a,f)=>a.length?sum(a,f)/a.length:0;
const pct = (c,p)=>p===0?0:((c-p)/p)*100;

/* ===============================
   FILTER SETUP
================================ */
function populateFilters() {
  stationFilter.innerHTML = `<option value="">All Stations</option>` +
    [...new Set(stations.map(s=>s.Station))].map(v=>`<option>${v}</option>`).join('');

  providerFilter.innerHTML = `<option value="">All Providers</option>` +
    [...new Set(bookings.map(b=>b.Provider).filter(Boolean))].map(v=>`<option>${v}</option>`).join('');

  agentFilter.innerHTML = `<option value="">All Agents</option>` +
    [...new Set(bookings.map(b=>b.Agent).filter(Boolean))].map(v=>`<option>${v}</option>`).join('');

  channelFilter.innerHTML = `<option value="">All Channels</option>` +
    [...new Set(bookings.map(b=>b["Selling channel"]).filter(Boolean))].map(v=>`<option>${v}</option>`).join('');
}

function setDefaultDates() {
  const d = bookings.map(b=>new Date(b.Checkout));
  dateFrom.value = new Date(Math.min(...d)).toISOString().slice(0,10);
  dateTo.value   = new Date(Math.max(...d)).toISOString().slice(0,10);
}

function resetFilters() {
  stationFilter.value = providerFilter.value = agentFilter.value = channelFilter.value = "";
  setDefaultDates();
  applyFilters();
}

/* ===============================
   CORE LOGIC
================================ */
function applyFilters() {

  const from = new Date(dateFrom.value);
  const to   = new Date(dateTo.value);
  if (isNaN(from) || isNaN(to)) return;

  const days = Math.max(1,(to-from)/86400000);
  const prevFrom = new Date(from.getTime()-days*86400000);
  const prevTo = new Date(from.getTime());

  const st=stationFilter.value, pr=providerFilter.value, ag=agentFilter.value, ch=channelFilter.value;

  const match = (b,f,t)=>
    (!st||b["Checkout Station"]===st)&&
    (!pr||b.Provider===pr)&&
    (!ag||b.Agent===ag)&&
    (!ch||b["Selling channel"]===ch)&&
    new Date(b.Checkout)>=f&&new Date(b.Checkout)<=t;

  const curr = bookings.filter(b=>match(b,from,to));
  const prev = bookings.filter(b=>match(b,prevFrom,prevTo));

  renderKPIs(curr,prev);
  renderCharts(curr,st);
}

/* ===============================
   KPI
================================ */
function renderKPIs(curr,prev){

  const kpis=[
    {l:"Prenotazioni",v:curr.length,p:prev.length},
    {l:"Revenue â‚¬",v:sum(curr,b=>b["Total revenue"]||0),p:sum(prev,b=>b["Total revenue"]||0)},
    {l:"Ancillaries â‚¬",v:sum(curr,b=>b.Ancillaries||0),p:sum(prev,b=>b.Ancillaries||0)},
    {l:"RevDay Anc.",v:avg(curr,b=>b["RevDay Ancillaries"]||0),p:avg(prev,b=>b["RevDay Ancillaries"]||0)},
    {l:"% Utilization",v:avg(stations,s=>s.utilization_current)*100,p:avg(stations,s=>s.utilization_current)*100},
    {l:"Vehicles in Maintenance",v:maintenance.length,p:maintenance.length}
  ];

  kpiContainer.innerHTML=kpis.map(k=>{
    const d=pct(k.v,k.p);
    return `
    <div class="bg-slate-900/80 p-4 rounded-xl border border-slate-800 shadow">
      <div class="text-slate-400 text-sm">${k.l}</div>
      <div class="text-2xl font-bold">${k.v.toFixed(1)}</div>
      <div class="${d>=0?'text-emerald-400':'text-red-400'} text-sm">
        ${d>=0?'+':''}${d.toFixed(1)}%
      </div>
    </div>`;
  }).join('');
}

/* ===============================
   CHARTS
================================ */
let charts={};

function renderCharts(curr,station){

  Object.values(charts).forEach(c=>c.destroy());
  charts={};

  const daily={};
  curr.forEach(b=>{
    const d=new Date(b.Checkout).toISOString().slice(0,10);
    daily[d]=(daily[d]||0)+1;
  });

  charts.lineDaily=new Chart(lineDaily,{
    type:'line',
    data:{labels:Object.keys(daily),datasets:[{
      data:Object.values(daily),
      borderColor:'#facc15',
      backgroundColor:'rgba(250,204,21,0.15)',
      fill:true,
      tension:0.35
    }]},
    options:{responsive:true,maintainAspectRatio:false,
      plugins:{title:{display:true,text:'Andamento Prenotazioni Giornaliere'}}}
  });

  const sd=stations.filter(s=>!station||s.Station===station);
  charts.lineStation=new Chart(lineStation,{
    type:'line',
    data:{labels:sd.map(s=>s.Station),datasets:[{
      label:'Utilization %',
      data:sd.map(s=>s.utilization_current*100),
      borderColor:'#10b981',
      backgroundColor:'rgba(16,185,129,0.15)',
      fill:true
    }]},
    options:{responsive:true,maintainAspectRatio:false,
      plugins:{title:{display:true,text:'Utilization Media per Station'}},
      scales:{y:{ticks:{callback:v=>v+'%'}}}}
  });

  charts.donutFleet=new Chart(donutFleet,{
    type:'doughnut',
    data:{labels:sd.map(s=>s.Station),datasets:[{data:sd.map(s=>s.fleet_current)}]},
    options:{responsive:true,maintainAspectRatio:false,
      plugins:{title:{display:true,text:'Distribuzione Fleet Current per Station'}}}
  });

  const mm={}; maintenance.forEach(m=>mm[m.Type]=(mm[m.Type]||0)+1);
  charts.donutMaintenance=new Chart(donutMaintenance,{
    type:'doughnut',
    data:{labels:Object.keys(mm),datasets:[{data:Object.values(mm)}]},
    options:{responsive:true,maintainAspectRatio:false,
      plugins:{title:{display:true,text:'Distribuzione Interventi di Manutenzione'}}}
  });
}
</script>
</body>
</html>
