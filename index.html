<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Fleet & Booking Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>

<body class="bg-slate-950 text-slate-100">

<div class="max-w-7xl mx-auto p-6 space-y-8">

  <!-- FILTRI -->
  <div class="grid grid-cols-1 md:grid-cols-6 gap-4">
    <input type="date" id="dateFrom" class="bg-slate-800 p-2 rounded">
    <input type="date" id="dateTo" class="bg-slate-800 p-2 rounded">

    <select id="stationFilter" class="bg-slate-800 p-2 rounded"></select>
    <select id="providerFilter" class="bg-slate-800 p-2 rounded"></select>
    <select id="agentFilter" class="bg-slate-800 p-2 rounded"></select>
    <select id="channelFilter" class="bg-slate-800 p-2 rounded"></select>
  </div>

  <!-- KPI -->
  <div id="kpiContainer" class="grid grid-cols-1 md:grid-cols-4 gap-6"></div>

  <!-- GRAFICI -->
  <div class="grid grid-cols-1 xl:grid-cols-2 gap-8">
    <div class="h-[380px] bg-slate-900 p-3 rounded">
      <canvas id="lineDaily"></canvas>
    </div>
    <div class="h-[380px] bg-slate-900 p-3 rounded">
      <canvas id="lineStation"></canvas>
    </div>
  </div>

  <div class="grid grid-cols-1 xl:grid-cols-2 gap-8">
    <div class="h-[320px] bg-slate-900 p-3 rounded">
      <canvas id="donutFleet"></canvas>
    </div>
    <div class="h-[320px] bg-slate-900 p-3 rounded">
      <canvas id="donutMaintenance"></canvas>
    </div>
  </div>

</div>

<script>
/* ===============================
   LOAD DATA
================================ */
let bookings = [], stations = [], maintenance = [];

Promise.all([
  fetch('prenotazioni.json').then(r => r.json()),
  fetch('reporting_stations.json').then(r => r.json()),
  fetch('maintenance_services.json').then(r => r.json())
]).then(([b, s, m]) => {
  bookings = b;
  stations = s;
  maintenance = m;
  init();
});

/* ===============================
   INIT
================================ */
function init() {
  populateFilters();
  setDefaultDates();
  applyFilters();

  dateFrom.addEventListener('change', applyFilters);
  dateTo.addEventListener('change', applyFilters);
  stationFilter.addEventListener('change', applyFilters);
  providerFilter.addEventListener('change', applyFilters);
  agentFilter.addEventListener('change', applyFilters);
  channelFilter.addEventListener('change', applyFilters);
}

/* ===============================
   HELPERS
================================ */
const sum = (arr, fn) => arr.reduce((a,b)=>a+fn(b),0);
const avg = (arr, fn) => arr.length ? sum(arr,fn)/arr.length : 0;
const pct = (c,p) => p === 0 ? 0 : ((c-p)/p)*100;

/* ===============================
   FILTER SETUP
================================ */
function populateFilters() {

  stationFilter.innerHTML =
    `<option value="">All Stations</option>` +
    [...new Set(stations.map(s => s.Station))]
      .map(v => `<option>${v}</option>`).join('');

  providerFilter.innerHTML =
    `<option value="">All Providers</option>` +
    [...new Set(bookings.map(b => b.Provider).filter(Boolean))]
      .map(v => `<option>${v}</option>`).join('');

  agentFilter.innerHTML =
    `<option value="">All Agents</option>` +
    [...new Set(bookings.map(b => b.Agent).filter(Boolean))]
      .map(v => `<option>${v}</option>`).join('');

  channelFilter.innerHTML =
    `<option value="">All Channels</option>` +
    [...new Set(bookings.map(b => b["Selling channel"]).filter(Boolean))]
      .map(v => `<option>${v}</option>`).join('');
}

function setDefaultDates() {
  const dates = bookings.map(b => new Date(b.Checkout));
  const min = new Date(Math.min(...dates));
  const max = new Date(Math.max(...dates));
  dateFrom.value = min.toISOString().slice(0,10);
  dateTo.value = max.toISOString().slice(0,10);
}

/* ===============================
   CORE LOGIC
================================ */
function applyFilters() {

  const from = new Date(dateFrom.value);
  const to = new Date(dateTo.value);
  if (isNaN(from) || isNaN(to)) return;

  const st = stationFilter.value;
  const pr = providerFilter.value;
  const ag = agentFilter.value;
  const ch = channelFilter.value;

  const filterBooking = b =>
    (!st || b["Checkout Station"] === st) &&
    (!pr || b.Provider === pr) &&
    (!ag || b.Agent === ag) &&
    (!ch || b["Selling channel"] === ch) &&
    new Date(b.Checkout) >= from &&
    new Date(b.Checkout) <= to;

  const curr = bookings.filter(filterBooking);
  const prev = []; // placeholder per confronto futuro

  renderKPIs(curr, prev);
  renderCharts(curr, st);
}

/* ===============================
   KPI
================================ */
function renderKPIs(curr, prev) {

  const fleetAvg = avg(stations, s => s.fleet_current);
  const utilAvg = avg(stations, s => s.utilization_current) * 100;

  const kpis = [
    { label: "Prenotazioni", v: curr.length, p: prev.length },
    { label: "Revenue €", v: sum(curr, b => b["Total revenue"] || 0), p: 0 },
    { label: "Ancillaries €", v: sum(curr, b => b.Ancillaries || 0), p: 0 },
    { label: "RevDay Anc.", v: avg(curr, b => b["RevDay Ancillaries"] || 0), p: 0 },
    { label: "% Utilization", v: utilAvg, p: 0 },
    { label: "Fleet Current", v: fleetAvg, p: 0 },
    { label: "Vehicles in Maintenance", v: maintenance.length, p: 0 }
  ];

  kpiContainer.innerHTML = kpis.map(k => `
    <div class="bg-slate-900 p-4 rounded">
      <div class="text-slate-400 text-sm">${k.label}</div>
      <div class="text-2xl font-bold">${k.v.toFixed(1)}</div>
      <div class="text-green-400 text-sm">0.0%</div>
    </div>
  `).join('');
}

/* ===============================
   CHARTS
================================ */
let charts = {};

function renderCharts(currBookings, selectedStation) {

  Object.values(charts).forEach(c => c.destroy());
  charts = {};

  /* LINE DAILY */
  const daily = {};
  currBookings.forEach(b => {
    const d = new Date(b.Checkout).toISOString().slice(0,10);
    daily[d] ??= 0;
    daily[d]++;
  });

  charts.lineDaily = new Chart(lineDaily,{
    type:'line',
    data:{
      labels:Object.keys(daily),
      datasets:[{
        label:'Prenotazioni',
        data:Object.values(daily),
        borderColor:'#38bdf8',
        fill:true,
        tension:0.3
      }]
    },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      plugins:{
        title:{
          display:true,
          text:'Andamento Prenotazioni Giornaliere',
          color:'#e5e7eb',
          font:{size:16,weight:'600'}
        },
        legend:{display:false}
      }
    }
  });

  /* LINE STATION */
  const stationData = stations.filter(
    s => !selectedStation || s.Station === selectedStation
  );

  charts.lineStation = new Chart(lineStation,{
    type:'line',
    data:{
      labels:stationData.map(s=>s.Station),
      datasets:[
        {
          label:'Fleet Current',
          data:stationData.map(s=>s.fleet_current),
          borderColor:'#22c55e'
        },
        {
          label:'Utilization %',
          data:stationData.map(s=>s.utilization_current*100),
          borderColor:'#f59e0b',
          yAxisID:'y1'
        }
      ]
    },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      plugins:{
        title:{
          display:true,
          text:'Performance Flotta per Station',
          color:'#e5e7eb',
          font:{size:16,weight:'600'}
        }
      },
      scales:{
        y:{position:'left'},
        y1:{position:'right',grid:{drawOnChartArea:false}}
      }
    }
  });

  /* DONUT FLEET */
  charts.donutFleet = new Chart(donutFleet,{
    type:'doughnut',
    data:{
      labels:stationData.map(s=>s.Station),
      datasets:[{data:stationData.map(s=>s.fleet_current)}]
    },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      plugins:{
        title:{
          display:true,
          text:'Distribuzione Fleet Current per Station',
          color:'#e5e7eb',
          font:{size:16,weight:'600'}
        }
      }
    }
  });

  /* DONUT MAINTENANCE (GLOBAL) */
  const maintMap = {};
  maintenance.forEach(m=>{
    maintMap[m.Type]=(maintMap[m.Type]||0)+1;
  });

  charts.donutMaintenance = new Chart(donutMaintenance,{
    type:'doughnut',
    data:{
      labels:Object.keys(maintMap),
      datasets:[{data:Object.values(maintMap)}]
    },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      plugins:{
        title:{
          display:true,
          text:'Distribuzione Interventi di Manutenzione',
          color:'#e5e7eb',
          font:{size:16,weight:'600'}
        }
      }
    }
  });
}
</script>
</body>
</html>
